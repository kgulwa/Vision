<% sanitized_uid = @user.uid.gsub("-", "") %>
<div class="max-w-5xl mx-auto py-8 px-4">
  <!-- Profile Header -->
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center space-x-4">
      <% if @user.avatar.attached? %>
        <%= image_tag url_for(@user.avatar),
              class: "rounded-full shadow object-cover",
              width: 96,
              height: 96 %>
      <% else %>
        <%= image_tag "default-avatar.png",
              width: 96,
              height: 96,
              class: "rounded-full shadow" %>
      <% end %>

      <div>
        <h1 class="text-3xl font-bold text-gray-900"><%= @user.username %></h1>

        <!-- FOLLOW SECTION -->
        <p class="text-gray-600">
          <span id="profile_follower_count_<%= sanitized_uid %>">
            <%= @user.followers.count %>
          </span> followers
        </p>

        <% if logged_in? && current_user != @user %>
          <%= render "users/follow_button", user: @user, page: "profile" %>
        <% end %>

        <!-- ‚≠ê CREATOR INSIGHTS BUTTON -->
        <% if current_user == @user %>
          <%= link_to "View Insights", insights_user_path(@user),
                class: "inline-block mt-3 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="flex space-x-6 border-b mb-6">
    <button data-tab-target="pins"
            class="py-2 font-semibold text-blue-600 border-b-2 border-blue-600">
      Pins
    </button>

    <button data-tab-target="reposts"
            class="py-2 font-semibold text-gray-600 hover:text-blue-600">
      Reposts
    </button>

    <button data-tab-target="tagged"
            class="py-2 font-semibold text-gray-600 hover:text-blue-600">
      Tagged
    </button>

    <% if @user == current_user %>
      <button data-tab-target="collections"
              class="py-2 font-semibold text-gray-600 hover:text-blue-600">
        Collections
      </button>
    <% end %>
  </div>

  <div class="space-y-8">
    <!-- PINS GRID -->
    <div id="tab-pins" class="grid grid-cols-2 md:grid-cols-3 gap-6">
      <% @pins.each do |pin| %>
        <%= link_to pin_path(pin), class: "block relative group" do %>
          <% if pin.file&.attached? %>
            <% if pin.file.content_type.starts_with?("video") %>
              <video class="rounded-lg shadow object-cover w-full h-48 md:h-60" muted>
                <source src="<%= url_for(pin.file) %>" type="<%= pin.file.content_type %>">
              </video>
            <% else %>
              <%= image_tag pin.file,
                  class: "rounded-lg shadow object-cover w-full h-48 md:h-60" %>
            <% end %>
          <% else %>
            <div class="w-full h-48 md:h-60 bg-gray-200 rounded-lg flex items-center justify-center">
              <span class="text-gray-400">No file</span>
            </div>
          <% end %>

          <div class="absolute inset-0 bg-black bg-opacity-40 opacity-0 group-hover:opacity-100
                      transition flex items-center justify-center space-x-6 text-white text-lg font-semibold">
            <span>‚ù§Ô∏è <%= pin.likes.count %></span>
            <span>üí¨ <%= pin.comments.count %></span>
          </div>
        <% end %>
      <% end %>

      <% if @pins.empty? %>
        <p class="col-span-full text-center text-gray-500 py-10">No pins yet.</p>
      <% end %>
    </div>

    <!-- REPOSTS GRID -->
    <div id="tab-reposts" class="hidden grid grid-cols-2 md:grid-cols-3 gap-6">
      <% @reposted_pins.each do |pin| %>
        <%= link_to pin_path(pin), class: "block relative group" do %>
          <% if pin.file&.attached? %>
            <% if pin.file.content_type.starts_with?("video") %>
              <video class="rounded-lg shadow object-cover w-full h-48 md:h-60" muted>
                <source src="<%= url_for(pin.file) %>" type="<%= pin.file.content_type %>">
              </video>
            <% else %>
              <%= image_tag pin.file,
                  class: "rounded-lg shadow object-cover w-full h-48 md:h-60" %>
            <% end %>
          <% else %>
            <div class="w-full h-48 md:h-60 bg-gray-200 rounded-lg flex items-center justify-center">
              No file
            </div>
          <% end %>

          <div class="absolute inset-0 bg-black bg-opacity-40 opacity-0 group-hover:opacity-100
                      transition flex items-center justify-center space-x-6 text-white text-lg font-semibold">
            <span>‚ù§Ô∏è <%= pin.likes.count %></span>
            <span>üí¨ <%= pin.comments.count %></span>
          </div>
        <% end %>
      <% end %>

      <% if @reposted_pins.empty? %>
        <p class="col-span-full text-center text-gray-500 py-10">No reposts yet.</p>
      <% end %>
    </div>

    <!-- TAGGED GRID -->
    <div id="tab-tagged" class="hidden grid grid-cols-2 md:grid-cols-3 gap-6">
      <% @tagged_pins.each do |pin| %>
        <%= link_to pin_path(pin), class: "block relative group" do %>
          <% if pin.file&.attached? %>
            <% if pin.file.content_type.starts_with?("video") %>
              <video class="rounded-lg shadow object-cover w-full h-48 md:h-60" muted>
                <source src="<%= url_for(pin.file) %>" type="<%= pin.file.content_type %>">
              </video>
            <% else %>
              <%= image_tag pin.file,
                  class: "rounded-lg shadow object-cover w-full h-48 md:h-60" %>
            <% end %>
          <% else %>
            <div class="w-full h-48 md:h-60 bg-gray-200 rounded-lg flex items-center justify-center">
              No file
            </div>
          <% end %>

          <div class="absolute inset-0 bg-black bg-opacity-40 opacity-0 group-hover:opacity-100
                      transition flex items-center justify-center space-x-6 text-white text-lg font-semibold">
            <span>‚ù§Ô∏è <%= pin.likes.count %></span>
            <span>üí¨ <%= pin.comments.count %></span>
          </div>

          <div class="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded">
            Tagged
          </div>
        <% end %>
      <% end %>

      <% if @tagged_pins.empty? %>
        <p class="col-span-full text-center text-gray-500 py-10">
          No tagged posts yet.
        </p>
      <% end %>
    </div>

    <!-- COLLECTIONS GRID -->
    <% if @user == current_user %>
      <div id="tab-collections" class="hidden grid grid-cols-2 md:grid-cols-3 gap-6">
        <% @user.collections.each do |collection| %>
          <%= link_to collection_path(collection), class: "block" do %>
            <div class="bg-gray-100 rounded-lg p-4 hover:shadow-md transition h-full">
              <h3 class="font-semibold mb-2"><%= collection.name %></h3>
              <p class="text-sm text-gray-500"><%= collection.saved_pins.count %> pins</p>
            </div>
          <% end %>
        <% end %>

        <% if @user.collections.empty? %>
          <p class="col-span-full text-center text-gray-500 py-10">
            No collections yet.
          </p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
  const buttons = document.querySelectorAll("[data-tab-target]");
  const tabs = {
    pins: document.getElementById("tab-pins"),
    reposts: document.getElementById("tab-reposts"),
    tagged: document.getElementById("tab-tagged"),
    collections: document.getElementById("tab-collections"),
  };

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => {
        b.classList.remove("text-blue-600", "border-blue-600", "border-b-2");
        b.classList.add("text-gray-600");
      });

      btn.classList.add("text-blue-600", "border-b-2", "border-blue-600");

      Object.values(tabs).forEach(tab => tab?.classList.add("hidden"));

      const target = btn.dataset.tabTarget;
      tabs[target]?.classList.remove("hidden");
    });
  });
</script>
