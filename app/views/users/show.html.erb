<% sanitized_uid = @user.uid.delete("-") %>

<div class="max-w-5xl mx-auto py-8 px-4">
  <!-- Profile Header -->
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center space-x-4">
      <% if @user.avatar.attached? %>
        <%= image_tag url_for(@user.avatar),
              class: "rounded-full shadow object-cover",
              width: 96,
              height: 96 %>
      <% else %>
        <%= image_tag "default-avatar.png",
              width: 96,
              height: 96,
              class: "rounded-full shadow" %>
      <% end %>

      <div>
        <h1 class="text-3xl font-bold text-gray-900"><%= @user.username %></h1>

        <p class="text-gray-600">
          <span id="profile_follower_count_<%= sanitized_uid %>">
            <%= @user.followers.count %>
          </span>
          followers
        </p>

        <% if logged_in? && current_user != @user %>
          <%= render "users/follow_button", user: @user, page: "profile" %>
        <% end %>

        <% if current_user == @user %>
          <%= link_to "View Insights",
                insights_user_path(@user),
                class: "inline-block mt-3 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="flex space-x-6 border-b mb-6">
    <button data-tab-target="pins"
            class="py-2 font-semibold text-blue-600 border-b-2 border-blue-600">
      Pins
    </button>

    <button data-tab-target="reposts"
            class="py-2 font-semibold text-gray-600 hover:text-blue-600">
      Reposts
    </button>

    <button data-tab-target="tagged"
            class="py-2 font-semibold text-gray-600 hover:text-blue-600">
      Tagged
    </button>

    <% if @user == current_user %>
      <button data-tab-target="collections"
              class="py-2 font-semibold text-gray-600 hover:text-blue-600">
        Collections
      </button>
    <% end %>
  </div>

  <div class="space-y-8">
    <!-- PINS -->
    <div id="tab-pins" class="grid grid-cols-2 md:grid-cols-3 gap-6">
      <% @profile.pins.each do |pin| %>
        <%= render "pins/grid_item", pin: pin %>
      <% end %>

      <% if @profile.pins.empty? %>
        <p class="col-span-full text-center text-gray-500 py-10">
          No pins yet.
        </p>
      <% end %>
    </div>

    <!-- REPOSTS -->
    <div id="tab-reposts" class="hidden grid grid-cols-2 md:grid-cols-3 gap-6">
      <% @profile.reposted_pins.each do |pin| %>
        <%= render "pins/grid_item", pin: pin %>
      <% end %>

      <% if @profile.reposted_pins.empty? %>
        <p class="col-span-full text-center text-gray-500 py-10">
          No reposts yet.
        </p>
      <% end %>
    </div>

    <!-- TAGGED -->
    <div id="tab-tagged" class="hidden grid grid-cols-2 md:grid-cols-3 gap-6">
      <% @profile.tagged_pins.each do |pin| %>
        <%= render "pins/grid_item", pin: pin, tagged: true %>
      <% end %>

      <% if @profile.tagged_pins.empty? %>
        <p class="col-span-full text-center text-gray-500 py-10">
          No tagged posts yet.
        </p>
      <% end %>
    </div>

    <!-- COLLECTIONS -->
    <% if @user == current_user %>
      <div id="tab-collections" class="hidden grid grid-cols-2 md:grid-cols-3 gap-6">
        <% @profile.collections.each do |collection| %>
          <%= link_to collection_path(collection), class: "block" do %>
            <div class="bg-gray-100 rounded-lg p-4 hover:shadow-md transition h-full">
              <h3 class="font-semibold mb-2"><%= collection.name %></h3>
              <p class="text-sm text-gray-500">
                <%= collection.saved_pins.count %> pins
              </p>
            </div>
          <% end %>
        <% end %>

        <% if @profile.collections.empty? %>
          <p class="col-span-full text-center text-gray-500 py-10">
            No collections yet.
          </p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener("turbo:load", () => {
  const buttons = document.querySelectorAll("[data-tab-target]");
  const tabs = {
    pins: document.getElementById("tab-pins"),
    reposts: document.getElementById("tab-reposts"),
    tagged: document.getElementById("tab-tagged"),
    collections: document.getElementById("tab-collections"),
  };

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b =>
        b.classList.remove("text-blue-600", "border-b-2", "border-blue-600")
      );

      btn.classList.add("text-blue-600", "border-b-2", "border-blue-600");

      Object.values(tabs).forEach(tab => tab?.classList.add("hidden"));
      tabs[btn.dataset.tabTarget]?.classList.remove("hidden");
    });
  });
});
</script>
